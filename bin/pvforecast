#!/usr/bin/python
# -*- coding: utf-8 -*-
"""
    pvforecast
    ~~~~~~~~~~
    
    To learn how to configure the photovoltaic forecast, see "pvforecast --help"

"""
import logging.config

import sys
import os
sys.path.insert(0, os.path.dirname(os.path.abspath(sys.argv[0])))

import inspect
import pytz as tz
import datetime as dt

from argparse import ArgumentParser, RawTextHelpFormatter
from configparser import ConfigParser
import datetime


def forecast(settings, time, model=None, state=None):
    from pvforecast import DatabaseList, SystemList, Weather
    
    database = DatabaseList(settings)
    systems = SystemList(settings, database)
    weather = Weather(settings, database, model=settings.get('Weather', 'model'))
    
    systems.forecast(weather, time, model, state, int(settings.get('General', 'interval')))
    

def schedule_forecast(scheduler, interval, time, settings, model=None, state=None):
    forecast(settings, time, model, state)
    
    time, delay = schedule_time(interval)
    scheduler.enter(delay, 1, forecast, 
                    (scheduler, interval, time, settings, model, state))


def schedule_time(interval):
    now = dt.datetime.now(tz.utc)
    time = now.replace(minute=0, second=0, microsecond=0)
    if now.hour % (interval/60) != 0:
        time = time + dt.timedelta(minutes=interval) - dt.timedelta(hours=now.hour % (interval/60))
    
    return time, (time + dt.timedelta(minutes=interval) - now).total_seconds()


def simulate(settings):
    forecast(settings, datetime.datetime(2008, 1, 1))


def run(settings, model=None, state=None):
    interval = int(settings.get('General', 'interval'))
    time,_ = schedule_time(interval)
    forecast(settings, time, model, state)


def start(settings, model=None, state=None):
    import sched, time
    
    logger.info('Starting pvforecast')
    
    interval = int(settings.get('General', 'interval'))
    scheduler = sched.scheduler(time.time, time.sleep)
    schedule_date, _ = schedule_time(interval)
    schedule_forecast(scheduler, interval, schedule_date, settings, model, state)
    scheduler.run()

    
def pretrain(settings):
    from pvforecast.learning import Learning
    logger.info('Starting pretraining on historical data')
    model = Learning()
    model.create_historical_dataset()
    model.pre_train_model()
    

def build(settings, rmlib):
    from pvforecast.database import ModuleDatabase, InverterDatabase
    
    logger.info('Starting pvforecast module library build')
    
    module_db = ModuleDatabase(settings)
    
    if rmlib:
        module_db.clean()
        
    module_db.build()
    
    logger.info('Starting pvforecast inverter library build')
    
    inverter_db = InverterDatabase(settings)
    
    if rmlib:
        inverter_db.clean()
    
    inverter_db.build()


def main(settings, args=None):
    settings.set('General', 'datadir', args.datadir)
    settings.set('General', 'configdir', args.configdir)
    
    state = None
    model = None
    if bool(settings.get('General', 'NN_forecast')):
        from pvforecast.learning import Learning
        state = dict()
        model = Learning(True, 'pretrained')
    
    if args.action == 'run':
        run(settings, model, state)
    
    elif args.action == 'start':
        start(settings, model, state)
    
    elif args.action == 'pretrain':
        pretrain(settings)
    
    elif args.action == 'simulate':
        simulate(settings)
    
    elif args.action == 'build':
        settings.set('General', 'dbdir', args.dbdir)
        
        build(settings, args.rmlib)


def _get_parser(settings, configdir):
    from pvforecast import __version__
    parser = ArgumentParser(description=__doc__, formatter_class=RawTextHelpFormatter)
    parser.add_argument('-v', '--version',
                        action='version',
                        version='%(prog)s {version}'.format(version=__version__))
    
    subparsers = parser.add_subparsers(dest='action')
    subparsers.required = True
    
    subparsers.add_parser('run', help='retrieve the latest weather forecast and provide consequently photovoltaic yield')
    
    subparsers.add_parser('start', help='Starts the ongoing calculation of photovoltaic yield in a regular interval')
    
    subparsers.add_parser('pretrain', help='Pretrain the neural network with historical data')
    
    subparsers.add_parser('simulate', help='Pvlib simulation')
    
    parser_build = subparsers.add_parser('build', help='Build the current photovoltaic module and inverter library')
    parser_build.add_argument('-r','--remove', action='store_true',
                        dest='rmlib',
                        help="remove the current library before rebuilding it")
    parser_build.add_argument('-db','--database',
                        dest='dbdir',
                        help="input directory containing the latest module and inverter databases",
                        required=True,
                        metavar='DIR')
    
    
    parser.add_argument('-c','--config',
                        dest='configdir',
                        help="directory of configuration files",
                        default=configdir,
                        metavar='DIR')
    
    parser.add_argument('-d','--data',
                        dest='datadir',
                        help="writable directory where certain configuration files may be found or results will be stored in",
                        default=settings.get('General', 'datadir'),
                        metavar='DIR')
    
    return parser


if __name__ == "__main__":
    rundir = os.path.dirname(os.path.abspath(inspect.getsourcefile(main)))
    if os.path.basename(rundir) == 'bin':
        rundir = os.path.dirname(rundir)
    
    configdir = os.path.join(rundir, 'conf')
    
    # Load the logging configuration
    loggingfile = os.path.join(configdir, 'logging.cfg')
    logging.config.fileConfig(loggingfile)
    logger = logging.getLogger('pvforecast')
    
    settingsfile = os.path.join(configdir, 'settings.cfg')
    if not os.path.isfile(settingsfile):
        logger.error('Unable to read settings at %s', settingsfile)
        sys.exit(1)
    
    settings = ConfigParser()
    settings.read(settingsfile)
    
    main(settings, args=_get_parser(settings, configdir).parse_args())

